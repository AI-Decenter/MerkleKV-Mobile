# CBOR Replication Event Schema (Spec §3.3)

> Deterministic CBOR encoding for replication change events with strict size limit ≤ 300 KiB (Spec §11).

## Schema

```json
{
  "key": "string",           // required (UTF-8)
  "node_id": "string",       // required
  "seq": 123,                // required (int64)
  "timestamp_ms": 1712345678901, // required (UTC ms, int64)
  "tombstone": false,        // required
  "value": "string"          // present ONLY if tombstone=false
}
```

## Deterministic Encoding

- Stable field order: key, node_id, seq, timestamp_ms, tombstone, value?
- Canonical representation for cross-device equality

## Size Limits (Spec §11)

- Total CBOR payload ≤ 300 KiB. At 300 KiB + 1 byte → error
- Enforced on both encode and decode

## Usage

```dart
// Encode
final bytes = CborSerializer.encode(
  ReplicationEvent.value(
    key: 'k',
    nodeId: 'n1',
    seq: 42,
    timestampMs: 1712345678901,
    value: 'hello',
  ),
);

// Decode
final evt = CborSerializer.decode(bytes);
```

## Tombstones

- tombstone=true → omit value in CBOR output
- Decoding enforces this rule

## Replication Event Publishing Format

The replication event publishing system (Issue #13) uses this CBOR schema for all published events:

### SET Operation Example

```cbor
{
  "key": "user:123",
  "node_id": "device-xyz", 
  "seq": 42,
  "timestamp_ms": 1640995200000,
  "tombstone": false,
  "value": "John Doe"
}
```

### DELETE Operation Example (Tombstone)

```cbor
{
  "key": "user:123",
  "node_id": "device-xyz",
  "seq": 43, 
  "timestamp_ms": 1640995260000,
  "tombstone": true
  // value field omitted
}
```

### Counter Operations (INCR/DECR)

```cbor
{
  "key": "counter:visits",
  "node_id": "device-xyz",
  "seq": 44,
  "timestamp_ms": 1640995320000, 
  "tombstone": false,
  "value": "42"  // String representation of numeric value
}
```

### Integration with Event Publisher

The CBOR serializer is integrated with the replication event publishing system:

- Events are generated by `ReplicationEventPublisher.createEventFromEntry()`
- CBOR encoding done by `CborSerializer.encode()` from Issue #12
- Base64-encoded CBOR is published to MQTT topic `{prefix}/replication/events`
- Deterministic serialization ensures identical payloads across nodes
- 300 KiB size limit prevents oversized events from being published

### Transport Format

Events are published as base64-encoded CBOR over MQTT:

```text
Topic: production/cluster-a/replication/events
Payload: pmNrZXlodXNlcjoxMjNnbm9kZV9pZGtkZW1vLW5vZGUtMWNzZXEBbHRpbWVzdGFtcF9tcxsAAAGZM...
```

The base64 payload decodes to the CBOR binary format for efficient network transmission.

## Errors

- Oversized payload → size-limit error (Spec §11)
- Malformed/invalid CBOR → parse/validation error
- Missing/invalid fields → schema validation error

## Testing & Determinism

- Golden vectors confirm identical binary output across devices
- Boundary tests: exact 300 KiB passes; +1 byte fails
