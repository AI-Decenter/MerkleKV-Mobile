# Mosquitto Configuration for Integration Testing
# Aligned with Locked Spec requirements for MerkleKV

# =============================================================================
# Network Configuration
# =============================================================================

# Default MQTT port (non-TLS)
listener 1883 0.0.0.0
protocol mqtt
socket_domain ipv4

# TLS MQTT port
listener 8883 0.0.0.0
protocol mqtt
socket_domain ipv4

# =============================================================================
# TLS Configuration
# =============================================================================

# Certificate Authority
cafile /mosquitto/config/tls/ca.crt

# Server certificate and key
certfile /mosquitto/config/tls/server.crt
keyfile /mosquitto/config/tls/server.key

# TLS settings - enforce TLS 1.2+ as per Locked Spec
tls_version tlsv1.2

# Client certificate validation
require_certificate true
use_identity_as_username true

# =============================================================================
# Authentication and Authorization
# =============================================================================

# Allow anonymous access for basic tests
allow_anonymous true

# Password file for authenticated tests
password_file /mosquitto/config/passwd

# Access Control List file
acl_file /mosquitto/config/acl.conf

# =============================================================================
# Message Size Limits (Aligned with Locked Spec)
# =============================================================================

# Maximum message size: 1MB (allows 256KiB values + overhead)
message_size_limit 1048576

# =============================================================================
# Persistence Configuration
# =============================================================================

# Enable persistence for testing durability
persistence true
persistence_location /mosquitto/data/
autosave_interval 60
autosave_on_changes false

# =============================================================================
# Queue Configuration
# =============================================================================

# Queue settings for partition tolerance testing
max_queued_messages 1000
max_inflight_messages 20

# =============================================================================
# Connection Settings
# =============================================================================

# Keep alive timeout
keepalive_interval 60

# Connection retry settings
retry_interval 20
max_connections -1

# =============================================================================
# Logging Configuration
# =============================================================================

log_dest file /mosquitto/log/mosquitto.log
log_dest stdout

log_type error
log_type warning
log_type notice
log_type information
log_type debug

# Connection logging for integration test debugging
connection_messages true

# =============================================================================
# WebSocket Configuration (Optional)
# =============================================================================

# Disabled for integration tests to reduce complexity
# listener 9001 0.0.0.0
# protocol websockets